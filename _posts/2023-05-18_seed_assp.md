---
layout: post
title: "Semillas y estados en generación de números aleatorios"
author: Memo y Nepo
tags: assp, random
---

¿Cuál es la situación?
Cuando estuvimos trabajando en la estimación del tamaño poblacional de petrel cenizo tuvimos problemas con las pruebas.
Al agregar un `describe` o un `it` cambiaban algunos resultados en las pruebas. 
Agregamos semillas y el problema lo resolvimos parcialmente.
- Los resultados eran diferente dependiendo de como corremos las pruebas: solo un archivo, en la instalación o todas las pruebas.
`simdataCJS`

¿Qué intentamos?
Intentamos agregar semillas a las pruebas: en el inicio de los archivos pruebas, al incio de los `describe` y hasta en los `it`. 
También pusimos semillas en el código de producción. 
Primero como argumento opciona y después las fijamos desde la definición de las funciones.

¿Cómo intentamos restaurar las semillas?
Parecía que alguna función modificaba la secuencia de números aleatorios.
Pensábamos que al utilizar números aleatorios anidados era cuando los resultados no eran los que sperábamos.
Intentamos fijar las semillas antes de cada prueba con `set.seed()`. 
Y al final de cada prueba tratamos de restablecer el `.Random.seed` con `set.seed(NULL)`.
Este precedimiento lo repetimos en el código de producción.

¿Qué propuso Xie?
Xie nos señaló que había diferntes ambientes y por eso mismo diferente `.Random.seed`.
La manera correcta de reestablecer esa variable era con tres funciones.
Con la primera obtenemos el estado global del generador de números aleatorios
``` R
get_rand_state <- function() {
  get0(".Random.seed", envir = .GlobalEnv, inherits = FALSE)
}
```
Con la segundo podemos regresamos al estado que guardamos de `.Random.seed`:
``` R
set_rand_state <- function(state) {
  if (!is.null(state)) {
    assign(".Random.seed", state, envir = .GlobalEnv, inherits = FALSE)
  }
}
```
Por último, para asegurar que fije el estado de la variable `.Random.seed` al salir de alguna función, debemos de usar la función `on.exit()`.
Por ejemplo:
```R
my_f <- function() {
  old_state <- get_rand_state()
  on.exit(set_rand_state(old_state))
}
```

¿Qué aprendimos?
Con lo anterior nos aseguramos que podíamos obtener el mismo valor de `.Random.seed`. 
A pesar de lo anterior, los resultados de las pruebas seguín dependiendo de cómo las corríamos.
Eso nos ayudó a darnos cuenta que el generador de números a leatorios cambiaba. Creemos que ese cambio era en el `RNGKind`. Intentamos fijar el esta variable y de todas formas los resultados cambian.
Al final nos quedamos con la impresión que este comportamiento era debido a las estimaciones de población abierta. Una función que utilizamos era `simdataCJS`. 


¿Conclusión?
